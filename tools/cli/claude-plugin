#!/usr/bin/env bash

# Claude Plugin CLI
# Manage Claude Code agents, skills, and templates

set -e

VERSION="2.0.0"
CLAUDE_DIR="${HOME}/.claude"
PLUGINS_FILE="${CLAUDE_DIR}/plugins.json"
AGENTS_DIR="${CLAUDE_DIR}/agents"
SKILLS_DIR="${CLAUDE_DIR}/skills"
TEMPLATES_DIR="${CLAUDE_DIR}/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Ensure directories exist
init_dirs() {
    mkdir -p "$AGENTS_DIR" "$SKILLS_DIR" "$TEMPLATES_DIR"
    if [[ ! -f "$PLUGINS_FILE" ]]; then
        echo '{"registries":[],"installed":[]}' > "$PLUGINS_FILE"
    fi
}

# Print colored output
print_info() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}$1${NC}"; }
print_warning() { echo -e "${YELLOW}$1${NC}"; }
print_error() { echo -e "${RED}$1${NC}"; }
print_header() { echo -e "${CYAN}$1${NC}"; }

# Show help
show_help() {
    cat << EOF
Claude Plugin CLI v${VERSION}

Usage: claude-plugin <command> [options]

Commands:
  marketplace add <owner/repo>     Add a plugin registry
  marketplace remove <name>        Remove a registry
  marketplace list                 List added registries

  list [--type <agent|skill|template>]  List available items
  search <query>                   Search across all types
  install <name>                   Install an agent, skill, or template
  uninstall <name>                 Uninstall an item
  installed                        List installed items

  info <name>                      Show details about an item

Options:
  -h, --help                       Show this help
  -v, --version                    Show version

Examples:
  claude-plugin marketplace add Smaiil/awesome-claude-agents
  claude-plugin list
  claude-plugin list --type skill
  claude-plugin install code-reviewer
  claude-plugin install commit
  claude-plugin search "python"
EOF
}

# Fetch marketplace.json from a GitHub repo
fetch_marketplace() {
    local source="$1"
    local owner_repo="${source#github:}"
    local url="https://raw.githubusercontent.com/${owner_repo}/main/.claude-plugin/marketplace.json"
    curl -sL "$url"
}

# Add a registry
marketplace_add() {
    local source="$1"

    if [[ -z "$source" ]]; then
        print_error "Usage: claude-plugin marketplace add <owner/repo>"
        exit 1
    fi

    # Normalize source
    if [[ ! "$source" =~ ^github: ]]; then
        source="github:$source"
    fi

    local owner_repo="${source#github:}"
    print_info "Fetching registry from ${owner_repo}..."

    # Fetch and validate marketplace.json
    local manifest
    manifest=$(fetch_marketplace "$source")

    if [[ -z "$manifest" ]] || ! echo "$manifest" | jq -e '.name' > /dev/null 2>&1; then
        print_error "Invalid registry: Could not fetch marketplace.json"
        exit 1
    fi

    local name
    name=$(echo "$manifest" | jq -r '.name')

    # Check if already added
    if jq -e ".registries[] | select(.name == \"$name\")" "$PLUGINS_FILE" > /dev/null 2>&1; then
        print_warning "Registry '$name' is already added"
        exit 0
    fi

    # Add to plugins.json
    local added_date
    added_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    jq --arg name "$name" \
       --arg source "$source" \
       --arg date "$added_date" \
       '.registries += [{"name": $name, "source": $source, "added": $date}]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Added registry: $name ($owner_repo)"

    # Show available items count
    local agent_count skill_count template_count
    agent_count=$(echo "$manifest" | jq '[.agents[]?.items | length] | add // 0')
    skill_count=$(echo "$manifest" | jq '[.skills[]?.items | length] | add // 0')
    template_count=$(echo "$manifest" | jq '[.templates | length] | . // 0')

    print_info "  ${agent_count} agents, ${skill_count} skills, ${template_count} templates available"
}

# Remove a registry
marketplace_remove() {
    local name="$1"

    if [[ -z "$name" ]]; then
        print_error "Usage: claude-plugin marketplace remove <name>"
        exit 1
    fi

    if ! jq -e ".registries[] | select(.name == \"$name\")" "$PLUGINS_FILE" > /dev/null 2>&1; then
        print_error "Registry '$name' not found"
        exit 1
    fi

    jq --arg name "$name" '.registries = [.registries[] | select(.name != $name)]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Removed registry: $name"
}

# List registries
marketplace_list() {
    local registries
    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$registries" ]]; then
        print_warning "No registries added yet"
        echo ""
        echo "Add one with:"
        echo "  claude-plugin marketplace add <owner/repo>"
        exit 0
    fi

    echo "Installed Registries:"
    echo "---------------------"
    echo "$registries" | while IFS=$'\t' read -r name source; do
        echo "  $name"
        echo "    Source: $source"
    done
}

# List items from all registries
list_items() {
    local filter_type="$1"
    local registries

    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$registries" ]]; then
        print_warning "No registries added. Add one first:"
        echo "  claude-plugin marketplace add <owner/repo>"
        exit 0
    fi

    echo "$registries" | while IFS=$'\t' read -r name source; do
        print_header "[$name]"
        echo ""

        local manifest
        manifest=$(fetch_marketplace "$source")

        # List agents
        if [[ -z "$filter_type" ]] || [[ "$filter_type" == "agent" ]]; then
            local agents
            agents=$(echo "$manifest" | jq -r '.agents[]? | "  \(.name):", (.items[]? | "    - \(.name): \(.description)")')
            if [[ -n "$agents" ]]; then
                print_info "Agents:"
                echo "$agents"
                echo ""
            fi
        fi

        # List skills
        if [[ -z "$filter_type" ]] || [[ "$filter_type" == "skill" ]]; then
            local skills
            skills=$(echo "$manifest" | jq -r '.skills[]? | "  \(.name):", (.items[]? | "    - /\(.name): \(.description)")')
            if [[ -n "$skills" ]]; then
                print_info "Skills:"
                echo "$skills"
                echo ""
            fi
        fi

        # List templates
        if [[ -z "$filter_type" ]] || [[ "$filter_type" == "template" ]]; then
            local templates
            templates=$(echo "$manifest" | jq -r '.templates[]? | "    - \(.name): \(.description)"')
            if [[ -n "$templates" ]]; then
                print_info "Templates:"
                echo "$templates"
                echo ""
            fi
        fi
    done
}

# Find item in registries (returns: type, path, registry, source)
find_item() {
    local item_name="$1"
    local registries

    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    while IFS=$'\t' read -r reg_name source; do
        local manifest
        manifest=$(fetch_marketplace "$source")

        # Check agents
        local agent_path
        agent_path=$(echo "$manifest" | jq -r --arg name "$item_name" \
            '.agents[]? | . as $cat | .items[]? | select(.name == $name) | "\($cat.path)/\(.file)"')
        if [[ -n "$agent_path" ]]; then
            echo "agent|${agent_path}|${reg_name}|${source}"
            return 0
        fi

        # Check skills
        local skill_path
        skill_path=$(echo "$manifest" | jq -r --arg name "$item_name" \
            '.skills[]? | . as $cat | .items[]? | select(.name == $name) | "\($cat.path)/\(.file)"')
        if [[ -n "$skill_path" ]]; then
            echo "skill|${skill_path}|${reg_name}|${source}"
            return 0
        fi

        # Check templates
        local template_path
        template_path=$(echo "$manifest" | jq -r --arg name "$item_name" \
            '.templates[]? | select(.name == $name) | .file')
        if [[ -n "$template_path" ]]; then
            echo "template|${template_path}|${reg_name}|${source}"
            return 0
        fi
    done <<< "$registries"

    return 1
}

# Install an item
install_item() {
    local item="$1"
    local registry=""
    local item_name=""

    if [[ -z "$item" ]]; then
        print_error "Usage: claude-plugin install <name>"
        exit 1
    fi

    # Parse registry:item format
    if [[ "$item" == *":"* ]]; then
        registry="${item%%:*}"
        item_name="${item#*:}"
    else
        item_name="$item"
    fi

    # Find the item
    local result
    if ! result=$(find_item "$item_name"); then
        print_error "Item '${item_name}' not found in any registry"
        exit 1
    fi

    IFS='|' read -r item_type item_path reg_name source <<< "$result"

    local owner_repo="${source#github:}"
    local file_url="https://raw.githubusercontent.com/${owner_repo}/main/${item_path}"

    # Determine destination directory
    local dest_dir dest
    case "$item_type" in
        agent) dest_dir="$AGENTS_DIR" ;;
        skill) dest_dir="$SKILLS_DIR" ;;
        template) dest_dir="$TEMPLATES_DIR" ;;
    esac
    dest="${dest_dir}/${item_name}.md"

    print_info "Installing ${item_type}: ${item_name} from ${reg_name}..."

    # Download the item
    if curl -sL "$file_url" -o "$dest"; then
        # Update installed list
        local installed_date
        installed_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Remove if already installed, then add
        jq --arg name "$item_name" \
           '.installed = [.installed[] | select(.name != $name)]' \
           "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

        jq --arg name "$item_name" \
           --arg type "$item_type" \
           --arg registry "$reg_name" \
           --arg path "$dest" \
           --arg date "$installed_date" \
           '.installed += [{"name": $name, "type": $type, "registry": $registry, "path": $path, "installed": $date}]' \
           "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

        print_success "Installed ${item_type}: ${item_name}"
        print_info "  Location: ${dest}"

        # Show usage hint
        case "$item_type" in
            skill) print_info "  Usage: Type /${item_name} in Claude Code" ;;
            agent) print_info "  Usage: Reference in Task tool or agent config" ;;
            template) print_info "  Usage: Include in your prompts" ;;
        esac
    else
        print_error "Failed to download ${item_type}"
        exit 1
    fi
}

# Uninstall an item
uninstall_item() {
    local item="$1"

    if [[ -z "$item" ]]; then
        print_error "Usage: claude-plugin uninstall <name>"
        exit 1
    fi

    local path
    path=$(jq -r --arg name "$item" '.installed[] | select(.name == $name) | .path' "$PLUGINS_FILE")

    if [[ -z "$path" ]]; then
        print_error "Item '${item}' is not installed"
        exit 1
    fi

    # Remove file
    rm -f "$path"

    # Update plugins.json
    jq --arg name "$item" '.installed = [.installed[] | select(.name != $name)]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Uninstalled: ${item}"
}

# List installed items
list_installed() {
    local installed
    installed=$(jq -r '.installed[] | "\(.type)\t\(.name)\t\(.registry)"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$installed" ]]; then
        print_warning "No items installed"
        exit 0
    fi

    echo "Installed Items:"
    echo "----------------"

    local current_type=""
    echo "$installed" | sort | while IFS=$'\t' read -r type name registry; do
        if [[ "$type" != "$current_type" ]]; then
            current_type="$type"
            print_info "${type}s:"
        fi
        echo "  - ${name} (${registry})"
    done
}

# Search items
search_items() {
    local query="$1"

    if [[ -z "$query" ]]; then
        print_error "Usage: claude-plugin search <query>"
        exit 1
    fi

    print_info "Searching for '${query}'..."
    echo ""

    local registries
    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    local found=false

    while IFS=$'\t' read -r name source; do
        local manifest
        manifest=$(fetch_marketplace "$source")

        local results=""

        # Search agents
        local agent_results
        agent_results=$(echo "$manifest" | jq -r --arg q "$query" \
            '.agents[]?.items[]? | select((.name | test($q; "i")) or (.description | test($q; "i")) or (.tags[]? | test($q; "i"))) | "  [agent] \(.name): \(.description)"')
        results+="$agent_results"

        # Search skills
        local skill_results
        skill_results=$(echo "$manifest" | jq -r --arg q "$query" \
            '.skills[]?.items[]? | select((.name | test($q; "i")) or (.description | test($q; "i")) or (.tags[]? | test($q; "i"))) | "  [skill] /\(.name): \(.description)"')
        [[ -n "$skill_results" ]] && results+=$'\n'"$skill_results"

        # Search templates
        local template_results
        template_results=$(echo "$manifest" | jq -r --arg q "$query" \
            '.templates[]? | select((.name | test($q; "i")) or (.description | test($q; "i")) or (.tags[]? | test($q; "i"))) | "  [template] \(.name): \(.description)"')
        [[ -n "$template_results" ]] && results+=$'\n'"$template_results"

        if [[ -n "$results" ]]; then
            found=true
            print_header "[$name]"
            echo "$results"
            echo ""
        fi
    done <<< "$registries"

    if [[ "$found" == false ]]; then
        print_warning "No items found matching '${query}'"
    fi
}

# Show info about an item
show_info() {
    local item_name="$1"

    if [[ -z "$item_name" ]]; then
        print_error "Usage: claude-plugin info <name>"
        exit 1
    fi

    # Check if installed
    local installed_info
    installed_info=$(jq -r --arg name "$item_name" '.installed[] | select(.name == $name)' "$PLUGINS_FILE")

    if [[ -n "$installed_info" ]]; then
        print_success "Status: Installed"
        echo "$installed_info" | jq -r '"  Type: \(.type)\n  Registry: \(.registry)\n  Path: \(.path)\n  Installed: \(.installed)"'
    else
        print_warning "Status: Not installed"
    fi

    # Find in registries
    local result
    if result=$(find_item "$item_name"); then
        IFS='|' read -r item_type item_path reg_name source <<< "$result"
        echo ""
        print_info "Available from: $reg_name"
        echo "  Type: $item_type"
        echo "  Path: $item_path"
    fi
}

# Main command router
main() {
    init_dirs

    case "${1:-}" in
        marketplace)
            case "${2:-}" in
                add) marketplace_add "$3" ;;
                remove) marketplace_remove "$3" ;;
                list) marketplace_list ;;
                *) print_error "Unknown marketplace command. Use: add, remove, list" ;;
            esac
            ;;
        list)
            local filter_type=""
            if [[ "${2:-}" == "--type" ]]; then
                filter_type="$3"
            fi
            list_items "$filter_type"
            ;;
        search) search_items "$2" ;;
        install) install_item "$2" ;;
        uninstall) uninstall_item "$2" ;;
        installed) list_installed ;;
        info) show_info "$2" ;;
        -v|--version) echo "claude-plugin v${VERSION}" ;;
        -h|--help|"") show_help ;;
        *) print_error "Unknown command: $1"; show_help ;;
    esac
}

main "$@"
