#!/usr/bin/env bash

# Claude Plugin CLI
# Manage Claude Code sub-agents, plugins, and templates

set -e

VERSION="1.0.0"
CLAUDE_DIR="${HOME}/.claude"
PLUGINS_FILE="${CLAUDE_DIR}/plugins.json"
AGENTS_DIR="${CLAUDE_DIR}/agents"
TEMPLATES_DIR="${CLAUDE_DIR}/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ensure directories exist
init_dirs() {
    mkdir -p "$AGENTS_DIR" "$TEMPLATES_DIR"
    if [[ ! -f "$PLUGINS_FILE" ]]; then
        echo '{"registries":[],"installed":[]}' > "$PLUGINS_FILE"
    fi
}

# Print colored output
print_info() { echo -e "${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}$1${NC}"; }
print_warning() { echo -e "${YELLOW}$1${NC}"; }
print_error() { echo -e "${RED}$1${NC}"; }

# Show help
show_help() {
    cat << EOF
Claude Plugin CLI v${VERSION}

Usage: claude-plugin <command> [options]

Commands:
  marketplace add <owner/repo>     Add a plugin registry
  marketplace remove <name>        Remove a registry
  marketplace list                 List added registries

  list [--registry <name>]         List available plugins
  search <query>                   Search plugins across registries
  install <plugin>                 Install a plugin
  uninstall <plugin>               Uninstall a plugin
  installed                        List installed plugins

  template list                    List available templates
  template install <name>          Install a template

  update [plugin]                  Update plugin(s)

Options:
  -h, --help                       Show this help
  -v, --version                    Show version

Examples:
  claude-plugin marketplace add VoltAgent/awesome-claude-code-subagents
  claude-plugin install code-reviewer
  claude-plugin install voltagent:backend-developer
EOF
}

# Fetch marketplace.json from a GitHub repo
fetch_marketplace() {
    local source="$1"
    local owner_repo="${source#github:}"
    local url="https://raw.githubusercontent.com/${owner_repo}/main/.claude-plugin/marketplace.json"
    curl -sL "$url"
}

# Add a registry
marketplace_add() {
    local source="$1"

    if [[ -z "$source" ]]; then
        print_error "Usage: claude-plugin marketplace add <owner/repo>"
        exit 1
    fi

    # Normalize source
    if [[ ! "$source" =~ ^github: ]]; then
        source="github:$source"
    fi

    local owner_repo="${source#github:}"
    print_info "Fetching registry from ${owner_repo}..."

    # Fetch and validate marketplace.json
    local manifest
    manifest=$(fetch_marketplace "$source")

    if [[ -z "$manifest" ]] || ! echo "$manifest" | jq -e '.name' > /dev/null 2>&1; then
        print_error "Invalid registry: Could not fetch marketplace.json"
        exit 1
    fi

    local name
    name=$(echo "$manifest" | jq -r '.name')

    # Check if already added
    if jq -e ".registries[] | select(.name == \"$name\")" "$PLUGINS_FILE" > /dev/null 2>&1; then
        print_warning "Registry '$name' is already added"
        exit 0
    fi

    # Add to plugins.json
    local added_date
    added_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    jq --arg name "$name" \
       --arg source "$source" \
       --arg date "$added_date" \
       '.registries += [{"name": $name, "source": $source, "added": $date}]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Added registry: $name ($owner_repo)"

    # Show available plugins
    local plugin_count
    plugin_count=$(echo "$manifest" | jq '[.categories[].plugins | length] | add // 0')
    print_info "  ${plugin_count} plugins available"
}

# Remove a registry
marketplace_remove() {
    local name="$1"

    if [[ -z "$name" ]]; then
        print_error "Usage: claude-plugin marketplace remove <name>"
        exit 1
    fi

    if ! jq -e ".registries[] | select(.name == \"$name\")" "$PLUGINS_FILE" > /dev/null 2>&1; then
        print_error "Registry '$name' not found"
        exit 1
    fi

    jq --arg name "$name" '.registries = [.registries[] | select(.name != $name)]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Removed registry: $name"
}

# List registries
marketplace_list() {
    local registries
    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$registries" ]]; then
        print_warning "No registries added yet"
        echo ""
        echo "Add one with:"
        echo "  claude-plugin marketplace add <owner/repo>"
        exit 0
    fi

    echo "Installed Registries:"
    echo "---------------------"
    echo "$registries" | while IFS=$'\t' read -r name source; do
        echo "  $name"
        echo "    Source: $source"
    done
}

# List plugins from all or specific registry
list_plugins() {
    local filter_registry="$1"
    local registries

    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$registries" ]]; then
        print_warning "No registries added. Add one first:"
        echo "  claude-plugin marketplace add <owner/repo>"
        exit 0
    fi

    echo "$registries" | while IFS=$'\t' read -r name source; do
        if [[ -n "$filter_registry" ]] && [[ "$name" != "$filter_registry" ]]; then
            continue
        fi

        print_info "[$name]"

        local manifest
        manifest=$(fetch_marketplace "$source")

        echo "$manifest" | jq -r '.categories[] | "  \(.name):", (.plugins[] | "    - \(.name): \(.description)")'
        echo ""
    done
}

# Install a plugin
install_plugin() {
    local plugin="$1"
    local registry=""
    local plugin_name=""

    if [[ -z "$plugin" ]]; then
        print_error "Usage: claude-plugin install <plugin-name>"
        exit 1
    fi

    # Parse registry:plugin format
    if [[ "$plugin" == *":"* ]]; then
        registry="${plugin%%:*}"
        plugin_name="${plugin#*:}"
    else
        plugin_name="$plugin"
    fi

    # Search for plugin in registries
    local found=false
    local registries
    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    while IFS=$'\t' read -r reg_name source; do
        if [[ -n "$registry" ]] && [[ "$reg_name" != "$registry" ]]; then
            continue
        fi

        local manifest
        manifest=$(fetch_marketplace "$source")

        # Find the plugin
        local plugin_info
        plugin_info=$(echo "$manifest" | jq -r --arg name "$plugin_name" \
            '.categories[] | . as $cat | .plugins[] | select(.name == $name) | "\($cat.path)/\(.file)"')

        if [[ -n "$plugin_info" ]]; then
            found=true
            local owner_repo="${source#github:}"
            local file_url="https://raw.githubusercontent.com/${owner_repo}/main/${plugin_info}"

            print_info "Installing ${plugin_name} from ${reg_name}..."

            # Download the plugin
            local dest="${AGENTS_DIR}/${plugin_name}.md"
            if curl -sL "$file_url" -o "$dest"; then
                # Update installed list
                local installed_date
                installed_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                # Remove if already installed, then add
                jq --arg name "$plugin_name" \
                   '.installed = [.installed[] | select(.name != $name)]' \
                   "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

                jq --arg name "$plugin_name" \
                   --arg registry "$reg_name" \
                   --arg path "$dest" \
                   --arg date "$installed_date" \
                   '.installed += [{"name": $name, "registry": $registry, "path": $path, "installed": $date}]' \
                   "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

                print_success "Installed: ${plugin_name}"
                print_info "  Location: ${dest}"
            else
                print_error "Failed to download plugin"
                exit 1
            fi
            break
        fi
    done <<< "$registries"

    if [[ "$found" == false ]]; then
        print_error "Plugin '${plugin_name}' not found in any registry"
        exit 1
    fi
}

# Uninstall a plugin
uninstall_plugin() {
    local plugin="$1"

    if [[ -z "$plugin" ]]; then
        print_error "Usage: claude-plugin uninstall <plugin-name>"
        exit 1
    fi

    local path
    path=$(jq -r --arg name "$plugin" '.installed[] | select(.name == $name) | .path' "$PLUGINS_FILE")

    if [[ -z "$path" ]]; then
        print_error "Plugin '${plugin}' is not installed"
        exit 1
    fi

    # Remove file
    rm -f "$path"

    # Update plugins.json
    jq --arg name "$plugin" '.installed = [.installed[] | select(.name != $name)]' \
       "$PLUGINS_FILE" > "${PLUGINS_FILE}.tmp" && mv "${PLUGINS_FILE}.tmp" "$PLUGINS_FILE"

    print_success "Uninstalled: ${plugin}"
}

# List installed plugins
list_installed() {
    local installed
    installed=$(jq -r '.installed[] | "  \(.name) (\(.registry))"' "$PLUGINS_FILE" 2>/dev/null)

    if [[ -z "$installed" ]]; then
        print_warning "No plugins installed"
        exit 0
    fi

    echo "Installed Plugins:"
    echo "------------------"
    echo "$installed"
}

# Search plugins
search_plugins() {
    local query="$1"

    if [[ -z "$query" ]]; then
        print_error "Usage: claude-plugin search <query>"
        exit 1
    fi

    print_info "Searching for '${query}'..."
    echo ""

    local registries
    registries=$(jq -r '.registries[] | "\(.name)\t\(.source)"' "$PLUGINS_FILE" 2>/dev/null)

    local found=false

    while IFS=$'\t' read -r name source; do
        local manifest
        manifest=$(fetch_marketplace "$source")

        local results
        results=$(echo "$manifest" | jq -r --arg q "$query" \
            '.categories[].plugins[] | select(.name | test($q; "i")) or select(.description | test($q; "i")) | "  \(.name): \(.description)"')

        if [[ -n "$results" ]]; then
            found=true
            print_info "[$name]"
            echo "$results"
            echo ""
        fi
    done <<< "$registries"

    if [[ "$found" == false ]]; then
        print_warning "No plugins found matching '${query}'"
    fi
}

# Main command router
main() {
    init_dirs

    case "${1:-}" in
        marketplace)
            case "${2:-}" in
                add) marketplace_add "$3" ;;
                remove) marketplace_remove "$3" ;;
                list) marketplace_list ;;
                *) print_error "Unknown marketplace command. Use: add, remove, list" ;;
            esac
            ;;
        list) list_plugins "$2" ;;
        search) search_plugins "$2" ;;
        install) install_plugin "$2" ;;
        uninstall) uninstall_plugin "$2" ;;
        installed) list_installed ;;
        template)
            case "${2:-}" in
                list) print_warning "Template listing not yet implemented" ;;
                install) print_warning "Template install not yet implemented" ;;
                *) print_error "Unknown template command. Use: list, install" ;;
            esac
            ;;
        update) print_warning "Update not yet implemented" ;;
        -v|--version) echo "claude-plugin v${VERSION}" ;;
        -h|--help|"") show_help ;;
        *) print_error "Unknown command: $1"; show_help ;;
    esac
}

main "$@"
